{% extends 'base.html.twig' %}

{% block title %}Cr√©ation d'√©quipe{% endblock %}
{% block body_class %}page-team{% endblock %}

{% block main %}
<section class="team-builder container">
  <header class="tb-header">
    <h1>Cr√©ation d‚Äô√©quipe</h1>
    <p>Choisis 4 Magical Girls al√©atoires parmi ta collection, place-les sur le plateau, puis lance une recherche de combat.</p>
  </header>

  <div class="tb-layout">
    <!-- Colonne gauche : tirage & banc -->
    <aside class="tb-sidebar">
      <div class="tb-items">
        <div class="tb-items__head">
          <h2>Objets</h2>
          <small>Glisse un objet sur une h√©ro√Øne (1 objet max)</small>
          <div class="tb-items__actions" style="margin-left:auto; display:flex; gap:.4rem; align-items:center;">
          </div>
        </div>
        <div class="tb-items__grid" id="items-grid">
          {% for it in items|slice(0,4) %}
            <button class="tb-item" type="button" data-item-id="{{ it.id }}" draggable="true" title="{{ it.name }} ‚Äî {{ it.desc|default('') }}">
              <img src="{{ asset(it.img) }}" alt="{{ it.name }}" loading="lazy">
            </button>
          {% else %}
            <div class="tb-items__empty">Ajoute des images dans public/images/items/</div>
          {% endfor %}
        </div>
      </div>
      <div class="tb-pick">
        <div class="tb-pick__head">
          <h2>Tirage</h2>
          <button class="btn btn-ghost" id="btn-reroll" type="button" title="Reroll limit√© √† 3">
            üîÑ Re-tirer <span id="reroll-count" style="margin-left:.35rem;opacity:.85"></span>
          </button>
        </div>
        <div class="tb-pick__grid" id="pick-grid"><!-- cartes tirage rendues par JS --></div>
      </div>

      <div class="tb-bench">
        <h2>Banc</h2>
        <div class="tb-bench__grid" id="bench-grid"><!-- cartes bench --></div>
      </div>

      <div class="tb-legend">
        <h3>Classes</h3>
        <div class="legend-list">
          <span class="tag tag-melee">DPS C√†C</span>
          <span class="tag tag-ranged">DPS distance</span>
          <span class="tag tag-tank">Tank</span>
          <span class="tag tag-heal">Healer</span>
        </div>
      </div>
    </aside>

    <!-- Plateau -->
    <main class="tb-board">
      <h2>Plateau</h2>
      <div class="board" id="board" data-cols="4" data-rows="4">
        {# Grille 4x4 visible: moiti√© gauche seulement #}
        {% for r in 0..3 %}
          {% for c in 0..3 %}
            <div class="cell" data-x="{{ c }}" data-y="{{ r }}"></div>
          {% endfor %}
        {% endfor %}
      </div>

      <div class="tb-actions">
        <button class="btn btn-primary" id="btn-lock" disabled>üîí Verrouiller & Rechercher</button>
  <div class="tb-hint">Place exactement 4 h√©ro√Ønes. Astuce: sur mobile, tape une carte puis une case.</div>
      </div>

      {# Zone d'affichage des bonus de synergie #}
      <div class="tb-bonuses">
        <strong>Synergies d'√©quipe</strong>
        <ul id="team-bonuses" class="bonus-list"></ul>
      </div>
    </main>
  </div>
</section>

{# overlay de chargement (skeleton) lors de la recherche #}
<div id="search-skeleton" class="tb-loading is-hidden" aria-hidden="true">
  <div class="tb-loading__ornaments" aria-hidden="true">
    <div class="mg-circle"></div>
    <div class="mg-wand" title="Magical matchmaking"></div>
    <div class="mg-stars">
      <span class="twinkle" style="--i:0;"></span>
      <span class="twinkle" style="--i:1;"></span>
      <span class="twinkle" style="--i:2;"></span>
      <span class="twinkle" style="--i:3;"></span>
      <span class="twinkle" style="--i:4;"></span>
      <span class="twinkle" style="--i:5;"></span>
      <span class="twinkle" style="--i:6;"></span>
      <span class="twinkle" style="--i:7;"></span>
      <span class="twinkle" style="--i:8;"></span>
      <span class="twinkle" style="--i:9;"></span>
      <span class="twinkle" style="--i:10;"></span>
      <span class="twinkle" style="--i:11;"></span>
    </div>
  </div>
  <div class="tb-loading__center">
    <div class="sk sk-card sk-card--xl">
      <div class="tb-loading__message" aria-live="polite">‚ú® Recherche en cours‚Ä¶ ‚ú®</div>
    </div>
  </div>
  <div class="tb-loading__veil"></div>
  </div>

{# donn√©es pour le JS #}
<script id="owned-girls-json" type="application/json">
  {{ owned_girls|json_encode()|raw }}
</script>
<script id="suggested-girls-json" type="application/json">
  {{ suggested_girls|json_encode()|raw }}
</script>
<script>
  window.ASSET_BASE = "{{ asset('') }}";  // <-- racine ("/"), plus "images/mg/"
  window.ITEMS = {{ items|json_encode()|raw }};
  window.MM = {
    start:  "{{ path('matchmaking_start') }}",                  // e.g. /matchmaking/start
    status: "{{ path('matchmaking_status', {ticketId:'__ID__'}) }}",  // we replace __ID__ in JS
    cancel: "{{ path('matchmaking_cancel', {ticketId: 0})|replace({'/0':'/'}) }}"
  };
  window.REROLLS_LEFT = {{ rerolls_left|default(3) }};
  window.REROLL_DEC_URL = "{{ path('app_team_reroll_dec') }}";
</script>
{% endblock %}
